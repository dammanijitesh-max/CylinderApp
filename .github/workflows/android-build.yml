name: Build Kivy APK

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Install all required system packages
      - name: Install system packages
        shell: bash
        run: |
          sudo apt update
          sudo apt install -y \
            python3 python3-pip python3-setuptools \
            git zip unzip wget openjdk-17-jdk coreutils \
            autoconf automake libtool pkg-config build-essential cmake \
            gettext m4 libffi-dev libssl-dev

      # Install Buildozer and dependencies
      - name: Install Buildozer
        shell: bash
        run: |
          python3 -m pip install --upgrade pip Cython
          python3 -m pip install buildozer

      # Prepare Android SDK / NDK folders manually
      - name: Prepare Android SDK and NDK
        shell: bash
        run: |
          mkdir -p ~/.buildozer/android/platform
          export ANDROID_SDK_ROOT=$HOME/.buildozer/android/platform/android-sdk
          export ANDROID_NDK_HOME=$HOME/.buildozer/android/platform/android-ndk-r25b
          echo "‚úÖ SDK and NDK directories prepared"

      # Prepare Autoconf/Libtool macros for libffi build
      - name: Prepare Autoconf / Libtool macros
        shell: bash
        run: |
          echo "‚öôÔ∏è Preparing system-wide libtool/autoconf macros..."
          sudo mkdir -p /usr/share/aclocal
          if [ -d "/usr/share/libtool" ]; then
            sudo cp -r /usr/share/libtool/* /usr/share/aclocal/ || true
          fi
          if [ -d "/usr/share/libtool/m4" ]; then
            sudo cp -r /usr/share/libtool/m4/* /usr/share/aclocal/ || true
          fi
          sudo cp -r /usr/share/aclocal/* /usr/local/share/aclocal/ || true
          echo "‚úÖ Autoconf macros prepared."

      # Build the APK using Buildozer
      - name: Build APK
        shell: bash
        run: |
          export ANDROID_SDK_ROOT=$HOME/.buildozer/android/platform/android-sdk
          export PATH=$PATH:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools
          export P4A_NO_DEPENDENCIES_CHECK=1
          export USE_SYSTEM_LIBFFI=1
          echo "üöÄ Starting Buildozer build (system libffi)..."
          python3 -m buildozer -v android debug
          echo "‚úÖ Build completed!"
          ls -R bin || true

      # Upload the APK as an artifact
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: CylinderApp-APK
          path: bin/*.apk
